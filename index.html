<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Document</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="description" content="Description" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, minimum-scale=1.0"
    />

    <!-- theme options -->
    <!-- simple docsify theme:
    - Very pretty and clean.
    - Sidebar could use some work - ie sectioning not clear
    - Top scrolls

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsify-themeable@0/dist/css/theme-simple.css">

    -->

    <!-- vue theme : 
    - OK but top bar doesn't scroll


  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/docsify@4/lib/themes/vue.css">  
  -->

    <!-- docsify-themeable
  
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/docsify-darklight-theme@3/dist/docsify-themeable/style.min.css" type="text/css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsify-themeable@0/dist/css/theme-simple.css" title="light">
  <link rel="stylesheet alternative" href="https://cdn.jsdelivr.net/npm/docsify-themeable@0/dist/css/theme-simple-dark.css" title="dark">

  -->
    <link
      rel="stylesheet"
      href="//cdn.jsdelivr.net/npm/docsify-darklight-theme@3/dist/docsify-themeable/style.min.css"
      type="text/css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/docsify-themeable@0/dist/css/theme-simple.css"
      title="light"
    />
    <link
      rel="stylesheet alternative"
      href="https://cdn.jsdelivr.net/npm/docsify-themeable@0/dist/css/theme-simple-dark.css"
      title="dark"
    />

    <!-- instantsearch CSS 
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/instantsearch.css@7.4.5/themes/reset-min.css" integrity="sha256-QlHlZdbSVxaYkUHxhMFhAj/L3pJiW1LuomSCONXBWms=" crossorigin="anonymous"> -->

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/instantsearch.css@7.4.5/themes/satellite-min.css"
      integrity="sha256-TehzF/2QvNKhGQrrNpoOb2Ck4iGZ1J/DI4pkd2oUsBc="
      crossorigin="anonymous"
    />

    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
  </head>
  <body>
    <style>
      .material-icons.md-18 {
        font-size: 18px;
      }
    </style>
    <nav>
      <select id="lang-selector" name="lang" class="nav-select">
        <option value="en">English</option>
        <option value="ko">한국어 (Korean)</option>
        <option value="zh">中文 (Chinese)</option>
      </select>
      <select id="ver-selector" name="ver" class="nav-select">
        <option value="main">main</option>
        <option value="v1.15">v1.15</option>
        <option value="v1.22">v1.22</option>
      </select>
      <a
        id="edit_link"
        target="_blank"
        title="Edit on Github"
        class="icon-edit"
        style="display: none; font-size: 18px"
        ><span class="material-icons md-18">mode_edit</span></a
      >
    </nav>
    <div id="searchbox"></div>
    <div id="hits"></div>
    <div id="app"></div>
    <script>
      window.$docsify = {
        name: "PX4 User Guide",
        repo: "https://github.com/PX4/PX4-user_guide",
        //logo: '/assets/logo.png',
        executeScript: true,
        loadSidebar: "SUMMARY.md",
        relativePath: true,
        //loadNavbar: true, // Currently need to use coded navbar to get selectors working.
        //fallbackLanguages: ['zh', 'ko'],  //Not using fallback. This only works back to the "root" so would have to make en/master in the root. Messy.
        maxLevel: 3,
        subMaxLevel: 3,
        routerMode: "history", // use proper paths rather than hash paths. Allows google indexing. Pity not html.
        //This is correct, but will fail as site is too big for localStorage
        search: {
          paths: "auto",
          //namespace: 'px4-website',
          hideOtherSidebarContent: true,
          depth: 4,
          namespaceFacetMap: {
            lang: { en: "en-US", zh: "zh-CN", ko: "ko-KR" },
          },

          templates: {
            //base: options => 'Base',
            //style: options => 'Style',
            resultItem: (result, response, options) => {
              const { hierarchy } = result;
              const { _highlightResult } = result;
              // find best full match of set.
              // If get full match use the first hierarchy, not the second one.

              let title = "";
              let matchingText = "";
              //if (hierarchy.lvl0) title=`${hierarchy.lvl0}`; // I think this is the text from summary/toc

              for (const prop in _highlightResult.hierarchy) {
                console.log(
                  `_highlightResult.hierarchy.${prop}\n matchlevel: ${_highlightResult.hierarchy[prop].matchLevel}\n value: ${_highlightResult.hierarchy[prop].value}`
                );
                if (`${prop}` == "lvl0") {
                  console.log("skip lvl0");
                  continue;
                } else if (
                  _highlightResult.hierarchy[prop].matchLevel == "none"
                ) {
                  continue;
                } else if (
                  _highlightResult.hierarchy[prop].matchLevel == "full"
                ) {
                  matchingText += `<p>${_highlightResult.hierarchy[prop].value}</p>`;
                }
              }

              if (hierarchy.lvl1) title += ` ${hierarchy.lvl1}`;
              if (hierarchy.lvl2) title += ` > ${hierarchy.lvl2}`;
              if (hierarchy.lvl3) title += ` > ${hierarchy.lvl3}`;
              if (hierarchy.lvl4) title += ` > ${hierarchy.lvl4}`;

              //const matchingText = result._snippetResult.content.value;
              //const matchingText = result._highlightResult.hierarchy.lvl1.value;

              return `
                       <div class="matching-post">
                           <a href="${result.url}">
                              <h2>${title}</h2>
                              ${matchingText}
                           </a>
                       </div>`;

              /*
			                return `
                       <div class="matching-post">
                           <a href="${result.url}">
                              <h2>${title}</h2>
                              <p>${matchingText}</p>
                           </a>
                       </div>`;
			*/
            },
          },

          algolia: {
            token: "48919e1dffc6e0ce4c0d6331343d2c0e", // https://www.algolia.com/doc/guides/security/api-keys/
            appId: "HHWW7I44JO", // Your app id,

            defaultIndex: "px4",

            // single index
            //indexes: 'px4',

            // single index with settings
            indexes: {
              index: "px4",
              settings: {
                hitsPerPage: 10,
              },
            },
          },
        },

        namespaces: [
          {
            id: "version",
            values: ["main", "v1.15", "v1.22", "redir_repo", "local"],
            optional: false,
            selector: "#ver-selector",
            default: "main",
          },
          {
            id: "lang",
            values: ["en", "zh", "ko"],
            optional: false,
            selector: "#lang-selector",
            default: "en",
          },
        ],

        alias: {
          // Alias for pages where the main version should always be used - put in the contribute folder.
          // Note, this changes the source used - the system still thinks that you're on the original version.
          "/v(\\d+)\.(\\d+)/(en|zh|ko)/contribute/(.*)":
            "https://raw.githubusercontent.com/hamishwillee/PX4-user_guide/main/$3/contribute/$4",

          //General redirects
          "/v(\\d+)\.(\\d+)/(en|zh|ko)/(.*)":
            "https://raw.githubusercontent.com/hamishwillee/PX4-user_guide/v$1.$2/$3/$4",
          "/main/(en|zh|ko)/(.*)":
            "https://raw.githubusercontent.com/hamishwillee/PX4-user_guide/main/$1/$2",

          //PR redirects: /redir_repo/lang/username/reponame/branchname/...
          //Allows any repo in the right format (i.e. with en from root to be imported).
          "/redir_repo/(.*?)/(.*?)/(.*?)/(.*?)/(.*)":
            "https://raw.githubusercontent.com/$2/$3/$4/$1/$5",

          //'/.*/_navbar.md': '/_navbar.md',
        },

        plugins: [
          function (hook, vm) {
            //Fixup images.
            // There's bug that means it can't find them in the tree
            // But we can get them from github as they have relative links
            hook.beforeEach(function (content) {
              // Set up path info useful getting page detail
              const sourceFileFullPath = vm.route.file;
              const sourceDirFullPathArray = vm.route.file.split("/");
              const sourceFileName = sourceDirFullPathArray.pop();
              const sourceDirPath = sourceDirFullPathArray.join("/");

              let fixcontent = content;

              //General markdown fixes
              if (!vm.isHTML) {
                // Make the github heading anchor format change to docsify format
                fixcontent = fixcontent.replaceAll(
                  /\s*{#([\w-]*)}/g,
                  " :id=$1"
                );

                // Fix up notes/tips with > **Note** syntax.
                fixcontent = fixcontent.replaceAll(
                  "> **Note** ",
                  "\n?> **Note:** "
                );
                fixcontent = fixcontent.replaceAll(
                  "> **Tip** ",
                  "\n?> **Tip:** "
                );
                fixcontent = fixcontent.replaceAll(
                  "> **Warning** ",
                  "\n!> **Warning:** "
                );
                fixcontent = fixcontent.replaceAll(
                  "> **Caution** ",
                  "\n!> **Warning:** "
                );

                // Fix up notes/tips with ::: syntax
                fixcontent = fixcontent.replaceAll(
                  /\:{3}(\S+)$(.*?)\:{3}/gms,
                  (match, type, note_text) => {
                    if (type.startsWith("note")) {
                      return `\n?> **Note:** ${note_text}`;
                    } else if (type.startsWith("tip")) {
                      return `\n?> **Tip:** ${note_text}`;
                    } else if (type.startsWith("warning")) {
                      return `\n!> **Warning:** ${note_text}`;
                    }
                    return match;
                  }
                );

                // Fix up youtube videos in format expected by vuepress.
                // Get the ID then simply turns into IMAGE and link using VID. i.e. it does this as below.
                //[![Alt text](https://img.youtube.com/vi/VID/0.jpg)](https://www.youtube.com/watch?v=VID)
                fixcontent = fixcontent.replaceAll(
                  /\@\[youtube\]\((.*?)\)/g,
                  (match, linkstring) => {
                    let vid = linkstring.split("/").pop();
                    vid = vid.split("?v=").pop();
                    vid = vid.split("&")[0];
                    return `[![Alt text](https://img.youtube.com/vi/${vid}/0.jpg)](https://www.youtube.com/watch?v=${vid})`;
                  }
                );

                // Removed vuepress version stuff that isn't used - now we just redirect to latest.
                fixcontent = fixcontent.replace(
                  "({{ $themeConfig.px4_version }})",
                  ""
                );

                // Just for parameter reference markdown with an anchor link
                // change incoming links to upper case so these all work
                // Docsify should not force links to lowr case.
                if (
                  vm.route.query.id &&
                  sourceFileName == "parameter_reference.md"
                ) {
                  // only do in the parameters.md file
                  const targetAnchor = vm.route.query.id;
                  const upperTargetAnchor = targetAnchor.toUpperCase();
                  if (targetAnchor != upperTargetAnchor) {
                    vm.route.query.id = upperTargetAnchor;
                  }
                }

                // Fix up uorb_graph.md
                // The options for selector are releative to root. This helps it find the actual locations of the files
                // Probably need to make this look for the files in the relative root.
                const sourceFilePath = vm.route.file;
                const sourceDirPath = sourceFilePath.substring(
                  0,
                  sourceFilePath.lastIndexOf("/")
                );
                const sourceRootPath = sourceDirPath.split("en/")[0];
                var regExGraph = /(option value=')(graph_.*?.json)'/gi;
                //fixcontent = fixcontent.replaceAll(regExGraph, `$1${sourceDirPath}/$2'`);
                fixcontent = fixcontent.replaceAll(
                  regExGraph,
                  `$1${sourceRootPath}.vuepress/public/en/middleware/$2'`
                );

                // Removed d3.v4.min.js - need to find a better way to import this - at moment is loaded into the index.
                // Can perhaps combine With the uorb__graph.
                // Need to do this because only first script is loaded
                // Note, using regexp because hard to exscape paths right in JS
                const regExUorb = /<script.*?d3js.org*?script>/i;
                fixcontent = fixcontent.replace(regExUorb, "");

                const regExRemd3 = /<script.*?d3js.org*?script>/i;

                //Replace uorb graph with a version served from a CDN
                fixcontent = fixcontent.replace(
                  "uorb_graph.js",
                  "https://cdn.jsdelivr.net/gh/PX4/PX4-user_guide@70a3e39/scripts/middleware/uorb_graph.js"
                );
              }

              //Fixs just for remote markdown
              if (vm.isRemoteUrl && !vm.isHTML) {
                // Set edit link for the english pages only
                // This might be done nicer. Think about plugin architecture.
                let current_file = sourceFileFullPath;
                current_file = current_file.split("/main/en/"); // Needs to also work for versions .... perhaps.
                const navMenuEditLink = document.getElementById("edit_link");
                if (current_file.length == 2) {
                  let editlink = current_file[1];
                  editlink = `${$docsify.repo}/edit/main/en/${editlink}`;
                  navMenuEditLink.setAttribute("href", editlink);
                  navMenuEditLink.setAttribute("style", "display: inline;");
                } else {
                  navMenuEditLink.setAttribute(
                    "style",
                    "display: none; font-size: 30px;"
                  );
                }

                //Fixup images in Markdown style images to absolute path
                fixcontent = fixcontent.replace(
                  /\!\[(.*?)\]\((.*?)\)/g,
                  (match, title, path) => {
                    let linkrootpath = sourceDirFullPathArray.slice();
                    let relpath = path;
                    if (relpath.startsWith("../")) {
                      while (relpath.startsWith("../")) {
                        relpath = relpath.slice(3);
                        linkrootpath.pop();
                      }
                      linkrootpath = linkrootpath.join("/");
                      linkrootpath = `${linkrootpath}/${relpath}`;
                      let imagestring = `<img src="${linkrootpath}" title="${title}" />`;
                      return imagestring;
                    } else {
                      return match;
                    }
                  }
                );

                //Fixup images in HTML style images to absolute path
                fixcontent = fixcontent.replace(
                  / src\=["'](.*?)["']/g,
                  (match, path) => {
                    let linkrootpath = sourceDirFullPathArray.slice();
                    let relpath = path;
                    if (relpath.startsWith("../")) {
                      while (relpath.startsWith("../")) {
                        relpath = relpath.slice(3);
                        linkrootpath.pop();
                      }

                      linkrootpath = linkrootpath.join("/");
                      linkrootpath = `${linkrootpath}/${relpath}`;
                      let imagestring = ` src='${linkrootpath}'`;
                      return imagestring;
                    } else {
                      return match;
                    }
                  }
                );

                //Fix up relative links reference:
                //[rcircle]: ../../assets/hardware/cables/red.png
                fixcontent = fixcontent.replace(
                  /^(\[.*?\]\:) (.*?)$/gm,
                  (match, title, path) => {
                    console.log(match);
                    let linkrootpath = sourceDirFullPathArray.slice();
                    let relpath = path;
                    if (relpath.startsWith("../")) {
                      while (relpath.startsWith("../")) {
                        relpath = relpath.slice(3);
                        linkrootpath.pop();
                      }
                      linkrootpath = linkrootpath.join("/");
                      linkrootpath = `${linkrootpath}/${relpath}`;
                      let relativelink = `${title} ${linkrootpath}`;
                      return relativelink;
                    } else {
                      return match;
                    }
                  }
                );
              }

              //Return the modified content
              return fixcontent;
            }); //End of this hook
          },
        ], //end of all plugins
      };
    </script>
    <!-- Docsify v4 -->
    <script src="//cdn.jsdelivr.net/npm/docsify@4"></script>

    <!-- docsify-themeable -->

    <script src="https://cdn.jsdelivr.net/npm/docsify-themeable@0/dist/js/docsify-themeable.min.js"></script>
    <script src="//unpkg.com/docsify/lib/plugins/external-script.min.js"></script>
    <script src="https://d3js.org/d3.v4.min.js" async></script>

    <!-- docsify-themeable darklight -->
    <!--
  <script
    src="//cdn.jsdelivr.net/npm/docsify-darklight-theme@3/dist/docsify-themeable/main.min.js"
    type="text/javascript">
  </script>
  <script
    src="//cdn.jsdelivr.net/npm/docsify-darklight-theme@3/dist/docsify-themeable/index.min.js"
    type="text/javascript">
  </script>

    -->
    <script
      src="//cdn.jsdelivr.net/npm/docsify-darklight-theme@3/dist/docsify-themeable/main.min.js"
      type="text/javascript"
    ></script>
    <!-- Updated script for the theme -->

    <!--
  <script
    src="https://cdn.jsdelivr.net/gh/hamishwillee/multidocsify_test@px4test_docsify/docsify_darklight_navbar.js"
    type="text/javascript">
  </script>

  -->

    <!-- During development
	  -->
    <script src="./docsify_darklight_navbar.js" type="text/javascript"></script>

    <!-- sidebar collapse: https://github.com/iPeng6/docsify-sidebar-collapse 
  
  -->
    <script src="//cdn.jsdelivr.net/npm/docsify-sidebar-collapse/dist/docsify-sidebar-collapse.min.js"></script>

    <!-- Namespaces: https://evilmartians.com/chronicles/easy-multi-language-multi-version-documentation-with-docsify-git-and-github-actions  -->
    <script src="https://unpkg.com/docsify-namespaced"></script>

    <!-- full text search: very cool but does not work on our size of database - though it might with some hints -->
    <!--
  <script src="//cdn.jsdelivr.net/npm/docsify/lib/plugins/search.min.js"></script>
  -->

    <!-- zoom image -->
    <script src="//cdn.jsdelivr.net/npm/docsify/lib/plugins/zoom-image.min.js"></script>

    <!-- algolia html -->
    <script src="http://localhost:1234/index.js"></script>
  </body>
</html>
